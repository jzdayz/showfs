<!DOCTYPE html>

<html lang="cn">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width"/>
    <title>FS</title>
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.7.1/dropzone.css">
</head>
<body>
<h4 id="head" align="center" onclick="copyHead()"></h4>
<button id="goBack" onclick="goBack()" type="button" class="btn btn-success" style="width: 100%">cd ..</button>
<div id="path"></div>
<table class="table table-striped table-hover ">
    <thead>
    <tr>
        <th>名称</th>
        <th>路径</th>
        <th>大小(字节)</th>
        <th>操作</th>
    </tr>
    </thead>
    <tbody id="contentBody">

    </tbody>
</table>
<form action="/main/upload" class="dropzone" id="dropzone">
    <div class="fallback">
        <input name="file" type="file" multiple/>
    </div>
</form>
<script type="text/javascript" src="./js/dropzone.js"></script>
<script>

    Dropzone.options.dropzone = {
        // 1TB
        maxFilesize: 1048576, // MB
        // 1 hour
        timeout: 3600000//milliseconds
    };

    let nowPath = "";
    const contentBody = document.getElementById("contentBody");
    const head = document.getElementById("head");
    const path = document.getElementById("path");

    function get(url) {
        const request = new XMLHttpRequest();
        request.open("GET", url, false);
        request.send();
        return JSON.parse(request.responseText);
    }

    function copyHead(){
        window.getSelection().selectAllChildren(head);
        document.execCommand ("Copy");
    }

    function loadHead(){
        const request = new XMLHttpRequest();
        request.open("GET", "/main/head", false);
        request.send();
        head.innerText = request.responseText;
    }
    loadHead();

    function loadData(path, back) {
        let body = get("/main/list?path=" + path + "&back=" + back);
        if (1000 !== body['code']) {
            return;
        }
        let s = body['body']['files'];
        nowPath = body['body']['path'];
        let contentAdd = "";
        s.forEach(function (va, index) {
            let aTag = "<a href='main/download?path=" + va['path'] + "' download='" + va['name'] + "'>下载</a>";
            let showUrl = "main/show?path=" + va['path'];
            let show = "<a style='cursor:pointer' onclick=urlOpen('"+showUrl+"')>显示</a>";
            let folder = va['folder'];
            let onClick = "";
            if (folder) {
                aTag = "";
                show = "";
                onClick = "onclick=clickPath('" + va['path'] + "') ";
            }
            contentAdd += "<tr class=\"table-active\" " + onClick + " >\n" +
                "        <td>" + va['name'] + "</td>\n" +
                "        <td>" + va['path'] + "</td>\n" +
                "        <td>" + va['size'] + "</td>\n" +
                "        <td>" + aTag + ' ' + show + "</td>\n" +
                "    </tr>"
        })
        contentBody.innerHTML = contentAdd;
        setPath();
    }

    function clickPath(path) {
        loadData(path, false);
    }
    
    function urlOpen(url) {
        window.open(url);
    }

    function setPath() {
        path.innerText = "路径: " + nowPath;
    }

    loadData("", false);

    function goBack() {
        loadData(nowPath, true)
    }

</script>

</body>
</html>